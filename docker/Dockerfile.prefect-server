# syntax=docker/dockerfile:1

ARG PYTHON_VERSION
ARG PREFECT_VERSION
FROM prefecthq/prefect:${PREFECT_VERSION}-python${PYTHON_VERSION}

# Set working directory in image
WORKDIR /app

# Install useful debugging tool
RUN apt-get update && apt-get install -y curl && apt-get clean

# Copy dependency files only (to take advantage of layer caching)
COPY pyproject.toml uv.lock README.md ./

# Install your package (and core deps only) at build time
RUN pip install uv && uv pip install --system prefect

# Entrypoint: migrate â†’ start API/services â†’ wait for health â†’ deploy â†’ stay up
ENTRYPOINT ["bash","-c","\
  set -euo pipefail; \
  echo 'ðŸ›   Migrating databaseâ€¦'; \
  prefect server database upgrade --yes; \
  echo 'ðŸš€  Starting Prefect APIâ€¦'; \
  prefect server start & PID=$!; \
  echo 'â³  Waiting for APIâ€¦'; \
  until curl -sSf http://localhost:4200/api/health > /dev/null; do sleep 1; done; \
  # echo 'ðŸ’§  Ensuring default work pool existsâ€¦'; \
  # prefect work-pool create default --type process || echo 'default pool exists'; \
  # echo 'ðŸ”§  Registering deploymentâ€¦'; \
  # python /app/prefect/data_pipeline_flow.py; \
  wait $PID \
"]
