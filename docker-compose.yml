services:
  controller:
    container_name: stockops-controller
    build:
      context: .
      dockerfile: docker/controller/Dockerfile
      args:
        PYTHON_VERSION: ${PYTHON_VERSION}
    ports:
      - "8000:8000"  # expose FastAPI
    restart: always

  airflow:
    container_name: stockops-airflow
    build:
      context: .
      dockerfile: docker/airflow/Dockerfile
      args:
        PYTHON_VERSION: ${PYTHON_VERSION}
        AIRFLOW_VERSION: ${AIRFLOW_VERSION}
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=false
    volumes:
      - ./airflow/dags:/opt/airflow/dags
    ports:
      - "8080:8080"
    command: >
      bash -c "
        airflow db init &&
        airflow users create --username admin --password admin --firstname Air --lastname Flow --role Admin --email admin@example.com &&
        airflow webserver & airflow scheduler
      "
